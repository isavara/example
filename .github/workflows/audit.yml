name: Audit

on:
  push:
    branches:
      - 'BFUEM-*'
      - main
  pull_request:
    branches:
      - main
      types:
        - opened
        - reopened
        - synchronize
        - closed

jobs:
  validate-workflow-conditions:
    name: Validate Workflow Conditions
    runs-on: gcp-public-runner-label-1
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
      is_merge_to_main: ${{ steps.check.outputs.is_merge_to_main }}
      is_pr_opened: ${{ steps.check.outputs.is_pr_opened }}
    steps:
      - id: check
        run: |
          EVENT_NAME="${{ github.event_name }}"
          PR_ACTION="${{ github.event.action }}"
          PR_MERGED="false"
          IS_MERGE_TO_MAIN="false"
          IS_PR_OPENED="false"

          # Check if the event is a pull_request
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            if [[ "$PR_ACTION" == "opened" || "$PR_ACTION" == "synchronize" || "$PR_ACTION" == "reopened" ]]; then
              IS_PR_OPENED="true"
            fi

            # Check if the PR is merged into main
            PR_MERGED="${{ github.event.pull_request.merged || false }}"
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
            if [[ "$PR_MERGED" == "true" && "$TARGET_BRANCH" == "main" ]]; then
              IS_MERGE_TO_MAIN="true"
            fi
          fi

          # Log the context
          echo "EVENT_NAME=$EVENT_NAME"
          echo "PR_ACTION=$PR_ACTION"
          echo "PR_MERGED=$PR_MERGED"
          echo "IS_MERGE_TO_MAIN=$IS_MERGE_TO_MAIN"
          echo "IS_PR_OPENED=$IS_PR_OPENED"

          # Output variables
          echo "proceed=true" >> $GITHUB_OUTPUT
          echo "is_merge_to_main=$IS_MERGE_TO_MAIN" >> $GITHUB_OUTPUT
          echo "is_pr_opened=$IS_PR_OPENED" >> $GITHUB_OUTPUT

      - name: Print Output Values
        run: |
          echo "Proceed value: $PROCEED"
          echo "Is Merge to Main: $IS_MERGE_TO_MAIN"
          echo "Is PR Opened: $IS_PR_OPENED"
        env:
          PROCEED: ${{ steps.check.outputs.proceed }}
          IS_MERGE_TO_MAIN: ${{ steps.check.outputs.is_merge_to_main }}
          IS_PR_OPENED: ${{ steps.check.outputs.is_pr_opened }}

  test:
    name: Job to run the tests
    runs-on: gcp-public-runner-label-1
    needs:
      - validate-workflow-conditions
    if: ${{ needs.validate-workflow-conditions.outputs.is_merge_to_main != 'true' && needs.validate-workflow-conditions.outputs.is_pr_opened != 'true' && needs.validate-workflow-conditions.outputs.proceed == 'true' }}
    defaults:
      run:
        working-directory: /home/githubrunner/actions-runner/_work/example/example/test

    steps:
      - name: Present working directory
        run: pwd
        
      - name: Check out this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: test
          
      - name: Extract Branch Name
        id: get-branch-name
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "branch_name=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Run branch and commit message checks
        run: |
          chmod +x /home/githubrunner/actions-runner/_work/example/example/test/.githooks/validate-branch-and-commit-msg
          export GIT_COMMIT_MSG_FILE=$(mktemp)
          echo "${{ github.event.head_commit.message }}" > $GIT_COMMIT_MSG_FILE
          export GIT_BRANCH_NAME="${{ steps.get-branch-name.outputs.branch_name }}"
          echo "Branch name: $GIT_BRANCH_NAME"
          /home/githubrunner/actions-runner/_work/example/example/test/.githooks/validate-branch-and-commit-msg $GIT_COMMIT_MSG_FILE

  update-mcm-gke:
    name: Update MCM on GKE
    runs-on: gcp-public-runner-label-1
    environment: dev
    needs:
      - validate-workflow-conditions
    if: ${{ needs.validate-workflow-conditions.outputs.is_merge_to_main == 'true' }}
    steps:
      - name: Print Step#1 in update-mcm-gke job
        run: echo "The job update-mcm-gke is running... because this is a merge to the main branch."
      - name: Print PATH
        run: echo $PATH
